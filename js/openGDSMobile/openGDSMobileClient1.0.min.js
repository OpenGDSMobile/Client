/* 2014-12-07 */ var serverURL="http://113.198.80.60/",serverFolder="OpenGDSMobileApplicationServer1.0/",geoServerURL="http://113.198.80.9/",vWorldKey="9E21E5EE-67D4-36B9-85BB-E153321EEE65",publicDatakey="",seoulAreaEnvkey="6473565a72696e7438326262524174",seoulRoadEnvkey="4b56506967696e7437317348694371";Config={},Config.map={},Config.map.init={center:[0,0],zoom:10},Config.map.projection=ol.proj.get("EPSG:900913"),Config.map.viewOptions={projection:Config.map.projection,center:Config.map.init.center,zoom:Config.map.init.zoom},Config.map.minScaleDenom={map:1e3,geolocation:1e4,search:1e4},Config.map.initialGeolocationMaxScale=null;var styleCache={},Map={};Map.map=null,Map.addMap={},Map.minResolution=null,Map.layers={},Map.deviceOrientation=null,Map.windowOrientation=void 0,Map.geolocation=null,Map.createBaseMap=function(a,b){null==Map.map?(Map.layers.baselayer=new ol.layer.Tile({title:"basemap",source:b}),Map.map=new ol.Map({layers:[Map.layers.baselayer],target:a,view:new ol.View(Config.map.viewOptions)}),Map.map.getView().on("change:rotation",function(){$.event.trigger({type:"maprotation",rotation:Map.map.getView().getRotation()})}),Map.map.getView().on("change:resolution",function(){Map.map.getView().getResolution()<Map.minResolution&&Map.map.getView().setResolution(Map.minResolution)})):(Map.map.removeLayer(Map.layers.baselayer),Map.map.addLayer(Map.layers.baselayer=new ol.layer.Tile({title:"basemap",source:b})))},Map.adjustedHeading=function(a){return void 0!=Map.windowOrientation&&(a-=Map.windowOrientation*Math.PI/180),a},Map.setRotation=function(a){Map.map.getView().setRotation(a)},Map.setWindowOrientation=function(a){Map.windowOrientation=a,null!=Map.deviceOrientation&&Map.deviceOrientation.getTracking()&&void 0!=Map.deviceOrientation.getHeading()&&Map.setRotation(Map.adjustedHeading(-Map.deviceOrientation.getHeading()))},Map.clampToScale=function(a){var b=Map.scaleDenomToResolution(a,!0);Map.map.getView().getResolution()<b&&Map.map.getView().setResolution(b)},Map.scaleDenomToResolution=function(a,b){var c=a/(Map.map.getView().getProjection().getMetersPerUnit()*(Config.map.dpi/.0254));return b?Map.map.getView().constrainResolution(c):c},Map.centerOnLocation=function(){Map.geolocation=new ol.Geolocation({projection:Map.map.getView().getProjection(),tracking:!0})};var Gui={};Gui.initialLoad=!0,Gui.selectedLayer=null,Gui.tracking=!0,Gui.updateLayout=function(){var a=$("div[data-role='footer']:visible"),b=$("div[data-role='header']:visible"),c=$("div[data-role='content']:visible:visible"),d=$(window).height(),e=d-(a.outerHeight()+b.outerHeight());c.outerHeight()+a.outerHeight()!==d&&(e-=c.outerHeight()-c.height()+1,c.height(e)),$("#map").width($(window).width()),$("#map").height(e)},Gui.initViewer=function(){Gui.updateLayout(),$(window).on("resize",function(){Gui.updateLayout()}),$(window).on("orientationchange",function(){Map.setWindowOrientation(window.orientation)});var a=new ol.proj.Projection({code:"EPSG:900913",extent:[-20037508.34,-20037508.34,20037508.34,20037508.34],units:"m"});ol.proj.addProjection(a),openGDSM.baseMap("map","osm"),Map.centerOnLocation(),Map.geolocation.once("change:position",function(){Map.map.getView().setCenter(Map.geolocation.getPosition())}),$(Map.map.getViewport()).bind("tap",function(a){Map.map.getEventPixel(a.originalEvent)}),Gui.updateLayout()},$(document).ready(function(){Gui.initViewer()});var openGDSM={};openGDSM.wmsMapUI={},openGDSM.wfsMap={};var date={},cur_date=new Date;!function(){openGDSM.init=function(){$(document).on("pageinit",function(){$.mobile.loader.prototype.options.text="loading",$.mobile.loader.prototype.options.textVisible=!1,$.mobile.loader.prototype.options.theme="a",$.mobile.loader.prototype.options.html=""})},openGDSM.baseMap=function(a,b){var c=null;"osm"==b?c=new ol.source.OSM:"vworld"==b&&(c=openGDSM.vWorld.TMS()),Map.createBaseMap(a,c)},openGDSM.wmsMapUI.vworld=function(a,b){makeData=function(a){var b="",c=$("input[name='vworldWMS']:checkbox");c.each(function(){$(this).is(":checked")&&(b+=$(this).attr("value"),b+=",")}),b=b.slice(0,-1),openGDSM.vWorld.wmsAPI(Map.map,a,b)},b=vWorldKey;for(var c=$("#"+a),d='Select Max 5<br><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',e=["LT_C_UQ111","LT_C_UQ112","LT_C_UQ113","LT_C_UQ114","LT_C_UQ121","LT_C_UQ122","LT_C_UQ123","LT_C_UQ124","LT_C_UQ125","LT_C_UQ126","LT_C_UQ127","LT_C_UQ128","LT_C_UQ129","LT_C_UQ130","LT_C_WKMBBSN","LT_C_TDWAREA","LT_L_FRSTCLIMB"],f=["도시지역","관리지역","농립지역","자연환경보전지역","경관지구","미관지구","고도지구","방화지구","방재지구","보존지구","시설보호지구","취락지구","개발진흥지구","특정용도제한지구","수자원[대권역]","보행우선구역","등산로"],g=0;g<e.length;g++)d+='<input type="checkbox" name="vworldWMS" class="custom"  id="id-'+e[g]+'" value="'+e[g]+'" /><label for="id-'+e[g]+'">'+f[g]+"</label>",0!=g&&(g+1)%2==0&&(d+='</fieldset><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">');d+='</fieldset><a href="#" id=wmsButton data-role="button" onclick=makeData("'+b+'","vworldWMS")>지도 추가</a>',c.html(d),c.trigger("create")},openGDSM.wfsMap.geoserver=function(a){var b=geoServerURL,c="opengds",d=Math.floor(256*Math.random()),e=Math.floor(256*Math.random()),f=Math.floor(256*Math.random()),g="rgba("+d+","+e+","+f+",0.7)",h=1;openGDSMGeoserver.wfs(Map.map,b,c,a,g,h)},openGDSM.PublicDataUI={visualTypeRadioBtn:function(a,b){b="undefined"!=typeof b?b:!0;for(var c='<fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',d=["map","chart","chartMap"],e=["맵","차트","맵&차트"],f=0;f<d.length;f++)c+='<input type="radio" name="visradio" class="custom"  id="id-'+d[f]+'" value="'+d[f]+'" ',0==b&&"chart"!=d[f]&&(c+="disabled "),0==f&&(c+="checked"),c+=' onclick="openGDSM.PublicDataUI.mapSelect($(this))"/><label for="id-'+d[f]+'">'+e[f]+"</label>";c+="</fieldset>",a.append(c),a.append('<div id="wfsMap"></div>')},inputDate:function(a){var b='<label for="dateValue">날짜 : </label><input type="date" id="dateValue"/>';a.append(b),this.dateChk=!0},inputTime:function(a){var b='<label for="timeValue">시간 : </label><input type="time" id="timeValue">';a.append(b),this.timeChk=!0},inputValueSetting:function(){this.dateChk&&$("#dateValue").attr("value",date.getYYYYMMDD("-")),this.timeChk&&$("#timeValue").attr("value",date.getHour()+":00")},processBtn:function(a,b,c,d){console.log(b),d="undefined"!=typeof d?d:"";var e='<a href="#" data-role="button" data-provider="'+d+'" data-serivce="'+c+'" onclick="openGDSM.'+b+'.makeData($(this))">시각화</a>';a.append(e)},mapSelect:function(a){var b=$("#wfsMap");if(b.is(":empty")){if("map"==a.val()||"chartMap"==a.val()){for(var c='<div data-role="fieldcontain"><select name="geoServerMap" id="geoserverSelectBox">',d=0;d<openGDSMGeoserver.mapLayers.length;d++)c+='<option value="'+openGDSMGeoserver.mapLayers[d]+'"',0==d&&(c+=" selected"),c+=">"+openGDSMGeoserver.mapLayers[d]+"</option>";c+="</select>",b.append(c),b.trigger("create")}}else"chart"==a.val()&&b.empty()}},openGDSM.seoulPublic={divName:"",apiKey:"",dateChk:!1,timeChk:!1,makeData:function(a){var b="",c="",d=$("input[name='visradio']:radio"),e=$("input[name='envradio']:radio");d.each(function(){$(this).is(":checked")&&(b=$(this).val())}),e.each(function(){$(this).is(":checked")&&(c=$(this).val())}),$("#"+this.divName).popup("close"),openGDSM.seoulOpenData.env.dataLoad(a.attr("data-serivce"),this.apiKey,b,c,$("select[name=geoServerMap]").val(),$("#dateValue").val(),$("#timeValue").val())},areaEnv:function(a){$("#"+a).empty(),this.divName=a,this.dateChk=!0,this.timeChk=!0,this.apiKey=seoulAreaEnvkey;var b=$("#"+a);openGDSM.PublicDataUI.visualTypeRadioBtn(b),openGDSM.PublicDataUI.inputDate(b),openGDSM.PublicDataUI.inputTime(b);for(var c='<label for="envValue">환경정보:</label><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',d=["pm10","pm25","so2","o3","no2","co"],e=["PM10","PM25","SO2","O3","NO2","CO"],f=0;f<d.length;f++)c+='<input type="radio" name="envradio" class="custom"  id="id-'+e[f]+'" value="'+e[f]+'"/><label for="id-'+e[f]+'"><img src="images/'+d[f]+'.png" width=30></label>',0!=f&&(f+1)%3==0&&(c+='</fieldset><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">');c+="</fieldset>",b.append(c),openGDSM.PublicDataUI.processBtn(b,"seoulPublic","TimeAverageAirQuality"),b.trigger("create"),openGDSM.PublicDataUI.inputValueSetting()},roadEnv:function(a){$("#"+a).empty(),this.divName=a,this.dateChk=!1,this.timeChk=!1,this.apiKey=seoulRoadEnvkey;var b=$("#"+this.divName);openGDSM.PublicDataUI.visualTypeRadioBtn(b,!1);for(var c='<label for="envValue">환경정보:</label><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',d=["pm10","pm25","so2","o3","no2","co"],e=["PM10","PM25","SO2","O3","NO2","CO"],f=0;f<d.length;f++)c+='<input type="radio" name="envradio" class="custom"  id="id-'+e[f]+'" value="'+e[f]+'"/><label for="id-'+e[f]+'"><img src="images/'+d[f]+'.png" width=30></label>',0!=f&&(f+1)%3==0&&(c+='</fieldset><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">');c+="</fieldset>",b.append(c),openGDSM.PublicDataUI.processBtn(b,"seoulPublic","RealtimeRoadsideStation"),b.trigger("create"),openGDSM.PublicDataUI.inputValueSetting()}},openGDSM.PublicDataPortal={apiKey:"",visualTypeRadioBtn:function(a,b){b="undefined"!=typeof b?b:!0;for(var c='<fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',d=["map","chart","chartMap"],e=["맵","차트","맵&차트"],f=0;f<d.length;f++)c+='<input type="radio" name="visradio" class="custom"  id="id-'+d[f]+'" value="'+d[f]+'" ',0==b&&(c+="disabled "),0==f&&(c+="checked"),c+=' onclick="openGDSM.PublicDataPortalUI.mapSelect($(this))"/><label for="id-'+d[f]+'">'+e[f]+"</label>";c+="</fieldset>",a.append(c),a.append('<div id="wfsMap"></div>')},makeData:function(a){var b="",c="",d="",e=$("input[name='visradio']:radio"),f=$("input[name='envradio']:radio"),g=$("input[name='arearadio']:radio");e.each(function(){$(this).is(":checked")&&(b=$(this).val())}),f.each(function(){$(this).is(":checked")&&(c=$(this).val())}),g.each(function(){$(this).is(":checked")&&(d=$(this).val())}),$("#"+this.divName).popup("close"),openGDSM.publicOpenData.env.dataLoad(a.attr("data-provider"),a.attr("data-serivce"),this.apiKey,b,c,d,$("select[name=geoServerMap]").val())},areaEnv:function(a,b){this.apiKey=encodeURIComponent(b),$("#"+a).empty(),this.divName=a;var c=$("#"+this.divName);openGDSM.PublicDataUI.visualTypeRadioBtn(c);for(var d='<label for="areaValue">지역:</label><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">',e=["서울","부산","대구","대전","광주","울산","인천","전남","전북","경남","경북","강원","경기","제주"],f=["서울","부산","대구","대전","광주","울산","인천","전남","전북","경남","경북","강원","경기","제주"],g=0;g<e.length;g++)d+='<input type="radio" name="arearadio" class="custom"  id="id-'+e[g]+'" value="'+f[g]+'"/><label for="id-'+e[g]+'">'+e[g]+"</label>",0!=g&&(g+1)%3==0&&(d+='</fieldset><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">');d+="</fieldset>",d+='<label for="envValue">환경정보:</label><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">';for(var h=["pm10","pm25","so2","o3","no2","co"],i=["pm10Value","so2Value","o3Value","no2Value","coValue"],g=0;g<h.length;g++)d+='<input type="radio" name="envradio" class="custom"  id="id-'+h[g]+'" value="'+i[g]+'"/><label for="id-'+h[g]+'"><img src="images/'+h[g]+'.png" width=30></label>',0!=g&&(g+1)%3==0&&(d+='</fieldset><fieldset data-role="controlgroup" data-type="horizontal" class="egov-align-center">');d+="</fieldset>",c.append(d),openGDSM.PublicDataUI.processBtn(c,"PublicDataPortal","ArpltnInforInqireSvc","airkorea"),c.trigger("create")}},createkeyValueJsonString=function(a){var b="{";for(var c in a)b=b+'"'+a[c].attr("data-key")+'":',b=b+'"'+a[c].attr("data-value"),b+=a.length-1==c?'"}':'",';return JSON.parse(b)},date.getYear=function(){return cur_date.getFullYear()},date.getDate=function(){return cur_date.getDate()},date.getMonth=function(){return cur_date.getMonth()},date.getHour=function(){var a,b=cur_date.getMinutes();return a=30>b?0==cur_date.getHours()?leadingZeros(cur_date.getHours()+23,2):leadingZeros(cur_date.getHours()-1,2):leadingZeros(cur_date.getHours(),2)},date.getMin=function(){return cur_date.getMinutes()},date.getYYYYMMDDHH=function(){var a,b=cur_date.getFullYear(),c=leadingZeros(cur_date.getMonth()+1,2),d=leadingZeros(cur_date.getDate(),2),e=cur_date.getMinutes();return 30>e?0==cur_date.getHours()?(d=leadingZeros(cur_date.getDate()-1,2),a=23):a=leadingZeros(cur_date.getHours()-1,2):a=leadingZeros(cur_date.getHours(),2),e="00",b+c+d+a+e},date.getYYYYMMDD=function(a){var b=cur_date.getFullYear(),c=leadingZeros(cur_date.getMonth()+1,2),d=leadingZeros(cur_date.getDate(),2);return null==a?b+c+d:b+a+c+a+d},leadingZeros=function(a,b){var c="";if(a=a.toString(),a.length<b)for(var d=0;d<b-a.length;d++)c+="0";return c+a}}(),openGDSM.vWorld={TMS:function(){return new ol.source.XYZ({url:"http://xdworld.vworld.kr:8080/2d/Base/201310/{z}/{x}/{y}.png"})},wmsAPI:function(a,b,c){var d=new ol.layer.Tile({source:new ol.source.TileWMS({url:"http://map.vworld.kr/js/wms.do",params:{domain:"http://localhost",apiKey:b,LAYERS:c,STYLES:c,FORMAT:"image/png",CRS:"EPSG:900913",EXCEPTIONS:"text/xml",TRANSPARENT:!0}})});a.addLayer(d)}},openGDSM.seoulOpenData={};var styleCache={};openGDSM.seoulOpenData.env={key:"6473565a72696e7438326262524174",serviceName:"",envType:"",visType:"",mapLayer:"",dateValue:"",timeValue:"",colorRange:["#4C4Cff","#9999FF","#4cff4c","#99ff99","#FFFF00","#FFFF99","#FF9900","#FF0000"],PM10Range:[15,30,55,80,100,120,200],PM25Range:[15,30,55,80,100,120,200],CORange:[1,2,5.5,9,10.5,12,15],NO2Range:[.015,.03,.05,.06,.1045,.15,.2],SO2Range:[.01,.02,.035,.05,.075,.1,.15],O3Range:[.02,.04,.06,.08,.1,.12,.3],dataLoad:function(a,b,c,d,e,f,g){e="undefined"!=typeof e?e:"",f="undefined"!=typeof f?f:"",g="undefined"!=typeof g?g:"",this.serviceName=a,this.envType=d,this.visType=c,this.mapLayer=e,this.dateValue=f,this.timeValue=g;var h='{"serviceName":"'+a+'", "keyValue":"'+b+'","dateValue":"'+f+'","timeValue":"'+g+'"}';h=JSON.parse(h),$.ajax({type:"POST",url:serverURL+serverFolder+"EnvironmentSeoulData.do",data:JSON.stringify(h),contentType:"application/json;charset=UTF-8",dataType:"json",success:function(a){"chart"==c?openGDSM.seoulOpenData.env.chartVisual(JSON.parse(a.data)):"map"==c?openGDSM.seoulOpenData.env.mapVisual(JSON.parse(a.data)):"chartMap"==c&&openGDSM.seoulOpenData.env.chartMapVisual(JSON.parse(a.data))},error:function(){console.log("err")}})},chartVisual:function(a){$("#dataSelect").popup("open");var b=[],c=this.xydivision(a[this.serviceName],this.envType,"MSRSTE_NM");"PM10"==this.envType?b=this.PM10Range:"PM25"==this.envType?b=this.PM25Range:"CO"==this.envType?b=this.CORange:"NO2"==this.envType?b=this.NO2Range:"SO2"==this.envType?b=this.SO2Range:"O3"==this.envType&&(b=this.O3Range),openGDSM.d3.barchart("d3View",c,this.colorRange,b)},mapVisual:function(a){var b=[],c=null,d=null,e=this.xydivision(a[this.serviceName],this.envType,"MSRSTE_NM");"PM10"==this.envType?b=this.PM10Range:"PM25"==this.envType?b=this.PM25Range:"CO"==this.envType?b=this.CORange:"NO2"==this.envType?b=this.NO2Range:"SO2"==this.envType?b=this.SO2Range:"O3"==this.envType&&(b=this.O3Range),openGDSMGeoserver.wfs(Map.map,serverURL,"opengds",this.mapLayer),d=Map.map.getLayers().getArray();for(var f=0;f<d.length;f++)d[f].get("title")==this.mapLayer&&(c=d[f]);styleCache={},c.setStyle(function(a,c){var d=5e3>c?a.get("SIG_KOR_NM"):"";if(!styleCache[d]){for(var f="",g=0;g<e[1].length;g++)if(d==e[1][g])for(var h=0;h<b.length;h++)if(e[0][g]<=b[h]){f=openGDSM.seoulOpenData.env.colorRange[h];break}styleCache[d]=[new ol.style.Style({fill:new ol.style.Fill({color:f}),stroke:new ol.style.Stroke({color:"#000000",width:1}),text:new ol.style.Text({font:"9px Calibri,sans-serif",text:d,fill:new ol.style.Fill({color:"#000"})})})]}return styleCache[d]}),c.setOpacity(.6),$("#interpolationMapImage").attr("src","http://113.198.80.60/html/aqm/resultImages/"+this.dateValue.split("-").join("")+this.timeValue.replace(":","")+this.envType+"_result.jpg"),$("#interpolationMapImage").attr("height","250px"),$("#interpolationMap").show()},chartMapVisual:function(a){$("#d3viewonMap").show();var b=[],c=this.xydivision(a[this.serviceName],this.envType,"MSRSTE_NM");"PM10"==this.envType?b=this.PM10Range:"PM25"==this.envType?b=this.PM25Range:"CO"==this.envType?b=this.CORange:"NO2"==this.envType?b=this.NO2Range:"SO2"==this.envType?b=this.SO2Range:"O3"==this.envType&&(b=this.O3Range),openGDSM.d3.barchart("d3viewonMap_sub",c,this.colorRange,b),this.mapVisual(a)},xydivision:function(a,b){var c=new Array;c[0]=new Array,c[1]=new Array;var d=a.row;return $.each(d,function(a){c[0].push(d[a][b]),c[1].push(d[a].MSRSTE_NM)}),c}},openGDSM.publicOpenData={urls:{airkorea:"http://openapi.airkorea.or.kr/openapi/service/rest/"}},openGDSM.publicOpenData.env={visType:"",envType:"",areaType:"",mapLayer:"",colorRange:["#4C4Cff","#9999FF","#4cff4c","#99ff99","#FFFF00","#FFFF99","#FF9900","#FF0000"],PM10Range:[15,30,55,80,100,120,200],CORange:[1,2,5.5,9,10.5,12,15],NO2Range:[.015,.03,.05,.06,.1045,.15,.2],SO2Range:[.01,.02,.035,.05,.075,.1,.15],O3Range:[.02,.04,.06,.08,.1,.12,.3],dataLoad:function(a,b,c,d,e,f,g){g="undefined"!=typeof g?g:"",this.visType=d,this.envType=e,this.areaType=f,this.mapLayer=g;var h='{"serviceName":"'+b+'","keyValue":"'+c+'","areaType":"'+encodeURIComponent(f)+'","envType":"'+e+'","provider":"'+a+'"}';h=JSON.parse(h),$.ajax({type:"POST",url:serverURL+serverFolder+"EnvironmentPublicData.do",data:JSON.stringify(h),contentType:"application/json;charset=UTF-8",dataType:"json",success:function(a){"chart"==d?openGDSM.publicOpenData.env.chartVisual(JSON.parse(a.data)):"map"==d?openGDSM.publicOpenData.env.mapVisual(JSON.parse(a.data)):"chartMap"==d&&openGDSM.publicOpenData.env.chartMapVisual(JSON.parse(a.data))},error:function(){console.log("err")}})},chartVisual:function(a){$("#dataSelect").popup("open");var b=[],c=this.JSONtoArray(a,this.envType,"stationName");"pm10Value"==this.envType?b=this.PM10Range:"coValue"==this.envType?b=this.CORange:"no2Value"==this.envType?b=this.NO2Range:"so2Value"==this.envType?b=this.SO2Range:"o3Value"==this.envType&&(b=this.O3Range),openGDSM.d3.barchart("d3View",c,this.colorRange,b)},mapVisual:function(a){var b=[],c=null,d=null,e=this.JSONtoArray(a,this.envType,"stationName");"pm10Value"==this.envType?b=this.PM10Range:"coValue"==this.envType?b=this.CORange:"no2Value"==this.envType?b=this.NO2Range:"so2Value"==this.envType?b=this.SO2Range:"o3Value"==this.envType&&(b=this.O3Range),openGDSMGeoserver.wfs(Map.map,serverURL,"opengds",this.mapLayer),d=Map.map.getLayers().getArray();for(var f=0;f<d.length;f++)d[f].get("title")==this.mapLayer&&(c=d[f]);styleCache={},c.setStyle(function(a,c){var d;if(d="Seoul_si"==openGDSM.publicOpenData.env.mapLayer?5e3>c?a.get("SIG_KOR_NM"):"":5e3>c?a.get("EMD_KOR_NM"):"",!styleCache[d]){for(var f="rgba(255,255,255,0.5)",g=0;g<e[1].length;g++)if(d==e[1][g])for(var h=0;h<b.length;h++)if(e[0][g]<=b[h]){f=openGDSM.seoulOpenData.env.colorRange[h];break}styleCache[d]=[new ol.style.Style({fill:new ol.style.Fill({color:f}),stroke:new ol.style.Stroke({color:"#000000",width:1}),text:new ol.style.Text({font:"9px Calibri,sans-serif",text:d,fill:new ol.style.Fill({color:"#000"})})})]}return styleCache[d]}),c.setOpacity(.6)},chartMapVisual:function(a){$("#d3viewonMap").show();var b=[],c=this.JSONtoArray(a,this.envType,"stationName");"pm10Value"==this.envType?b=this.PM10Range:"coValue"==this.envType?b=this.CORange:"no2Value"==this.envType?b=this.NO2Range:"so2Value"==this.envType?b=this.SO2Range:"o3Value"==this.envType&&(b=this.O3Range),openGDSM.d3.barchart("d3viewonMap_sub",c,this.colorRange,b),openGDSM.publicOpenData.env.mapVisual(a)},JSONtoArray:function(a,b,c){var d=new Array;d[0]=new Array,d[1]=new Array;var e=a.row;return $.each(e,function(a){d[0].push(e[a][b]),d[1].push(e[a][c])}),d}},openGDSM.d3={},openGDSM.d3.barchart=function(a,b,c,d){var e=17,f=0;$("#"+a).empty();var g=d3.select("#"+a).append("svg").attr("id","barChart").attr("width",$("#"+a).width()).attr("height",e*b[0].length),h=d3.max(b[0]),i=d3.scale.linear().domain([0,h]).range([0,$("#"+a).width()]);g.selectAll("rect").data(b[0]).enter().append("rect").attr("x",0).attr("y",function(a,b){return b*e}).attr("width",function(a){return i(a)-f}).attr("height",e-2).attr("fill",function(a,e){for(var f=0;f<d.length;f++)if(b[0][e]<=d[f])return c[f];return c[c.length]}),g.selectAll("g").data(b[1]).enter().append("text").attr("x",0).attr("y",function(a,b){return b*e+e-5}).attr("font-weight","bold").attr("font-size","0.9em").text(function(a){return a}),g.selectAll("g").data(b[0]).enter().append("text").attr("x",function(a){return i(a)-f}).attr("y",function(a,b){return b*e+12}).attr("dy",".15em").attr("fill","black").attr("font-size","0.8em").attr("font-weight","bold").text(function(a){return a})},openGDSM.d3.vectorMap={readVector:function(a){}};var openGDSMGeoserver={mapLayers:[]};openGDSMGeoserver.getLayers=function(){data={ws:"opengds"},this.mapLayers&&$.ajax({type:"POST",url:serverURL+serverFolder+"getLayerNames.do",data:JSON.stringify(data),contentType:"application/json;charset=UTF-8",dataType:"json",success:function(a){openGDSMGeoserver.mapLayers=a.data},error:function(){console.log("err")}})},openGDSMGeoserver.wfs=function(a,b,c,d,e,f,g){e="undefined"!=typeof e?e:"rgba(255,255,255,0.5)",f="undefined"!=typeof f?f:"1",g="undefined"!=typeof espg?g:"EPSG:900913",vectorSource=new ol.source.ServerVector({format:new ol.format.GeoJSON,loader:function(a){var e=b+"geoserver/wfs?service=WFS&version=1.1.0&request=GetFeature&typeNames="+c+":"+d+"&outputFormat=text/javascript&format_options=callback:loadFeatures&srsname="+g+"&bbox="+a.join(",")+","+g;$.ajax({url:e,dataType:"jsonp"})},strategy:ol.loadingstrategy.createTile(new ol.tilegrid.XYZ({maxZoom:19})),projection:g}),loadFeatures=function(a){vectorSource.addFeatures(vectorSource.readFeatures(a))};for(var h=[new ol.style.Style({fill:new ol.style.Fill({color:e}),stroke:new ol.style.Stroke({color:"#000000",width:1})})],i=a.getLayers().getArray(),j=0;j<i.length;j++)i[j].get("title")==d&&a.removeLayer(i[j]);var k=new ol.layer.Vector({title:d,source:vectorSource,style:h});a.addLayer(k)};
