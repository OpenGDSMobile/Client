<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>OGDSM_indexedDB.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OGDSM.html">OGDSM</a></li><li><a href="OGDSM.attributeTable.html">attributeTable</a><ul class='methods'><li data-type='method'><a href="OGDSM.attributeTable.html#.getEidtMode">getEidtMode</a></li><li data-type='method'><a href="OGDSM.attributeTable.html#.getSelectObj">getSelectObj</a></li></ul></li><li><a href="OGDSM.chartVisualization.html">chartVisualization</a></li><li><a href="OGDSM.eGovFrameUI.html">eGovFrameUI</a></li><li><a href="OGDSM.externalConnection.html">externalConnection</a></li><li><a href="OGDSM.mapLayerList.html">mapLayerList</a></li><li><a href="OGDSM.visualization.html">visualization</a><ul class='methods'><li data-type='method'><a href="OGDSM.visualization.html#getLayersTitle">getLayersTitle</a></li></ul></li><li><a href="OGDSM.webSocket.html">webSocket</a></li></ul><h3>Modules</h3><ul><li><a href="OGDSM.module_applyOptions.html">applyOptions</a></li><li><a href="OGDSM.module_indexedDB.html">indexedDB</a></li><li><a href="OGDSM.module_jsontoArray.html">jsontoArray</a></li><li><a href="OGDSM.module_namespace.html">namespace</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addAttribute">addAttribute</a></li><li><a href="global.html#addList">addList</a></li><li><a href="global.html#addMap">addMap</a></li><li><a href="global.html#ajaxRequest">ajaxRequest</a></li><li><a href="global.html#areaChart">areaChart</a></li><li><a href="global.html#autoButton">autoButton</a></li><li><a href="global.html#autoCheckBox">autoCheckBox</a></li><li><a href="global.html#autoListView">autoListView</a></li><li><a href="global.html#autoRadioBox">autoRadioBox</a></li><li><a href="global.html#autoSelect">autoSelect</a></li><li><a href="global.html#autoSwitch">autoSwitch</a></li><li><a href="global.html#baseMapRadioBox">baseMapRadioBox</a></li><li><a href="global.html#baseMapSelect">baseMapSelect</a></li><li><a href="global.html#changeBaseMap">changeBaseMap</a></li><li><a href="global.html#changeWFSStyle">changeWFSStyle</a></li><li><a href="global.html#dataPortalEnvironment">dataPortalEnvironment</a></li><li><a href="global.html#dataPortalEnvironmentLoad">dataPortalEnvironmentLoad</a></li><li><a href="global.html#dataPortalGreenGas">dataPortalGreenGas</a></li><li><a href="global.html#dataPortalNuclear">dataPortalNuclear</a></li><li><a href="global.html#dateInput">dateInput</a></li><li><a href="global.html#formAjaxRequest">formAjaxRequest</a></li><li><a href="global.html#geoServerGeoJsonLoad">geoServerGeoJsonLoad</a></li><li><a href="global.html#getAttrObj">getAttrObj</a></li><li><a href="global.html#getCurTab">getCurTab</a></li><li><a href="global.html#getEidtMode">getEidtMode</a></li><li><a href="global.html#getLayersGeoServer">getLayersGeoServer</a></li><li><a href="global.html#getMap">getMap</a></li><li><a href="global.html#greenGasEmissionLoad">greenGasEmissionLoad</a></li><li><a href="global.html#hBarChart">hBarChart</a></li><li><a href="global.html#imageLayer">imageLayer</a></li><li><a href="global.html#indexOf">indexOf</a></li><li><a href="global.html#layerCheck">layerCheck</a></li><li><a href="global.html#lineChart">lineChart</a></li><li><a href="global.html#olMapView">olMapView</a></li><li><a href="global.html#publicDataInterface">publicDataInterface</a></li><li><a href="global.html#realTimeLevelofRadiationLoad">realTimeLevelofRadiationLoad</a></li><li><a href="global.html#removeAttribute">removeAttribute</a></li><li><a href="global.html#removeList">removeList</a></li><li><a href="global.html#removeMap">removeMap</a></li><li><a href="global.html#selectAttribute">selectAttribute</a></li><li><a href="global.html#seoulEnvironment">seoulEnvironment</a></li><li><a href="global.html#seoulEnvironmentLoad">seoulEnvironmentLoad</a></li><li><a href="global.html#setCurTab">setCurTab</a></li><li><a href="global.html#setSelectObj">setSelectObj</a></li><li><a href="global.html#setVisible">setVisible</a></li><li><a href="global.html#timeInput">timeInput</a></li><li><a href="global.html#trackingGeoLocation">trackingGeoLocation</a></li><li><a href="global.html#updateLayoutSetting">updateLayoutSetting</a></li><li><a href="global.html#vBarChart">vBarChart</a></li><li><a href="global.html#vworldWMSList">vworldWMSList</a></li><li><a href="global.html#vworldWMSLoad">vworldWMSLoad</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">OGDSM_indexedDB.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*jslint devel: true, vars : true plusplus : true es5 : true */
/*global $, jQuery, OGDSM, mappingDB, IDBTransaction*/


/**
* OGDSM indexedDB 모듈
*
* - 사용 방법 (Use)
*       OGDSM.indexedDB('dbName'. {options});
* - Options
*   옵션 JSON 객체 키 값&lt;br>
{type:'new', storeName:dbName, insertKey:null, insertData:null,
searchKey: null, searchData: null, editData: null, deleteKey: null, success: false, file : false}&lt;br>
&lt;p style="font-weight:bold;">
type (String) : 모듈 실행 타입 설정 (필요 파라미터)
&lt;/p>
&lt;p style="padding-left:2em; background-color:#FFFFFF;">new : DB 생성/ 데이터 삽입 (dbName, storeName, insertData, insertKey)&lt;br>
    insert / forceInsert: 데이터 삽입 / 데이터 강제 삽입 (dbName, storeName, insertData, insertKey)&lt;br>
    searchAll / removeAll : 모든 데이터 검색 / 삭제 (dbName, storeName)&lt;br>
    search: DB 데이터 검색 (dbName, storeName, searchKey, searchData)&lt;br>
    remove: DB 데이터 삭제 (dbName, storeName, deleteKey)&lt;br>
    edit: DB 데이터 수정 (dbName, storeName, searchKey, searchData, editData)&lt;br>
    deleteDB: DB 삭제 (dbName)
&lt;/p>
&lt;p style="font-weight:bold;">
storeName (String) : 스토어&lt;br>
insertKey (String) : 삽입 대상 키&lt;br>
insertData (String) : 삽입 데이터&lt;br>
searchKey (String) : 검색 대상 키&lt;br>
searchData (String) : 검색할 데이터&lt;br>
editData (String) : 수정할 데이터&lt;br>
deleteKey (String) : 삭제할 키 데이터&lt;br>
success (function) : 성공 콜백 함수 (데이터 검색일 경우 데이터 파라미터로 보내짐)&lt;br>
fail (function) : 실패 콜백 함수&lt;br>
&lt;/p>
* @module OGDSM.indexedDB
**/
OGDSM.indexedDB = function (dbName, options) { //dbName_ StoreName, storeName, success, fail
    'use strict';
    var dbObject = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    var iDB = {};
    options = (typeof (options) !== 'undefined') ? options : {};
    var defaults = {
        type : 'new',
        storeName : dbName,
        insertKey : null,
        insertData : null,
        searchKey : null,
        searchData : null,
        editData : null,
        deleteKey : null,
        success : false,
        fail : false
    };
    defaults = OGDSM.applyOptions(defaults, options);
    if (typeof (Storage) !== 'undefined') {
        if (localStorage.openGDSMobileDBVersion) {
            localStorage.openGDSMobileDBVersion = localStorage.openGDSMobileDBVersion = 1;
        } else {
            localStorage.openGDSMobileDBVersion = localStorage.openGDSMobileDBVersion = 1;
        }
    }
    function insertData(dbName, storeName, data, keyColumn) {
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;
            var trans = iDB.db.transaction(storeName, 'readwrite').objectStore(storeName);
            var request = trans.openCursor();
            request.onsuccess = function (event) {
                var cursor = event.target.result;
                var chkKey = false;
                if (cursor) {
                    var field;
                    if (cursor.key === keyColumn) {
                        chkKey = true;
                    } else {
                        cursor.continue();
                    }
                }
                if (chkKey === false) {
                    trans.put(data, keyColumn);
                    trans.onsuccess = function (e) {
                        if (defaults.success) {
                            defaults.success(data);
                        } else {
                            console.log('Success Insert Data. Please call the second parameter of the callback function');
                        }
                        iDB.db.close();
                    };
                } else {
                    console.log('Fail Insert Data.');
                }
            };
        };
        req.onerror = function (e) {
            console.log(e);
            console.log("Database error: ", e.target.error);
        };
    }
    function updateData(dbName, storeName, data, keyColumn) {
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;
            var trans = iDB.db.transaction(storeName, 'readwrite').objectStore(storeName);
            trans.put(data, keyColumn);
            trans.onsuccess = function (e) {
                console.log("test");
                if (defaults.success) {
                    defaults.success(data);
                } else {
                    console.log('Success Update Data. Please call the second parameter of the callback function');
                }
                iDB.db.close();
            };
        };
        req.onerror = function (e) {
            console.log(e);
            console.log("Database error: ", e.target.error);
        };
    }
    function search(type, dbName, storeName, searchKey, searchData, editData) {
        searchKey = (typeof (searchKey) !== 'undefined') ? searchKey : null;
        searchData = (typeof (searchData) !== 'undefined') ? searchData : null;
        editData = (typeof (editData) !== 'undefined') ? editData : null;
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
//        console.log(req);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;
            if (iDB.db.objectStoreNames.length === 0) {
                console.log('Not Object Store');
                return -1;
            }
            var trans = iDB.db.transaction(storeName, 'readonly');
            var resultAll = [];
            var result = null;
            trans.oncomplete = function (evt) {
                var searchResult = null;
                var srcResult = null, dstResult = null;
                if (type === 'searchAll') {
                    if (defaults.success) {
                        if (resultAll.length !== 0) {
                            defaults.success(resultAll);
                        } else {
                            console.error('Not data');
                            defaults.fail(resultAll);
                        }
                    } else {
                        console.log('Success search Data. Please call the second parameter of the callback function');
                    }
                } else if (type === 'search' || type === 'edit') {
                    if (result !== null) {
                        if (searchData === null) {
                            console.log('OGDSM log : All search result based On Key');
                            defaults.success(result);
                            return -1;
                        }
                        var value;
                        if (Object.prototype.toString.call(result) === '[object Array]') {
                            var keys = Object.keys(result[0]);
                            var searchkeys = Object.keys(searchData);
                            var i, key;
                            srcResult = JSON.parse(JSON.stringify(result));
                            dstResult = JSON.parse(JSON.stringify(result));
                            for (value in result) {
                                if (result.hasOwnProperty(value)) {
                                    if (result[value][searchkeys[0]] === searchData[searchkeys[0]]) {
                                        searchResult = result[value];
                                        if (type === 'edit') {
                                            dstResult[value][searchkeys[0]] = editData;
                                            updateData(dbName, storeName, dstResult, searchKey);
                                        }
                                        break;
                                    }
                                }
                            }
                            if (defaults.success) {
                                if (searchResult !== null) {
                                    if (type === 'edit') {
                                        defaults.success(editData, srcResult, dstResult);
                                    } else {
                                        defaults.success(result, srcResult);
                                    }
                                } else {
                                    console.log('OGDSM Error : Not data');
                                    return -1;
                                }
                            } else {
                                console.log('Success search Data. Please call the second parameter of the callback function');
                            }
                        } else if (Object.prototype.toString.call(result) === '[object Object]') {
                            console.log(result);
                            console.log('object object');
                        }
                    } else {
                        console.log('OGDSM Error : Not data key');
                        defaults.fail('Not');
                    }
                }
            };
            var request = trans.objectStore(storeName).openCursor();
            request.onsuccess = function (event) {
                var cursor = event.target.result;
                if (cursor) {
                    var field;
                    var obj = {};
                    obj.key = cursor.key;
                    obj.value = cursor.value;
                    resultAll.push(obj);
                    if (cursor.key === searchKey) {
                        result = cursor.value;
                    } else {
                        cursor.continue();
                    }
                }
            };
        };
        req.onupgradeneeded = function (event) {
            iDB.db = event.target.result;
            console.log("new DB in search");
            if (storeName !== null) {
                if (iDB.db.objectStoreNames.contains(storeName)) {
                    console.log('Exist Store Name.');
                    //iDB.db.deleteObjectStore(storeName);

                } else {
                    iDB.db.createObjectStore(storeName);
                }
            }
        };
    }
    function edit(dbName, storeName, srcKey, srcData, dstData) {
        search('edit', dbName, storeName, srcKey, srcData, dstData);
    }
    function openDBInsertData(dbName, storeName, data, key) {
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;

            if (data !== null) {
                insertData(dbName, storeName, data, key);
            } else {
                if (defaults.success) {
                    defaults.success(iDB.db);
                } else {
                    console.log('Success Open / Create Indexed. Please call the second parameter of the callback function');
                }
            }
            iDB.db.close();
        };
        req.onupgradeneeded = function (event) {
            iDB.db = event.target.result;
            console.log("new DB in openDB");
            if (storeName !== null) {
                if (iDB.db.objectStoreNames.contains(storeName)) {
                    console.log('Exist Store Name.');
                  //  iDB.db.deleteObjectStore(storeName);
                } else {
                    iDB.db.createObjectStore(storeName);
                }
            }
        };
        req.onerror = function (e) {
            console.log("Database error: ", e.target.error);
        };
    }
    function removeData(dbName, storeName, key) {
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;
            var trans = iDB.db.transaction(storeName, 'readwrite');
            trans.objectStore(storeName).delete(key);
        };
    }
    function clearObjectStore(dbName, storeName) {
        var req = dbObject.open(dbName, localStorage.openGDSMobileDBVersion);
        req.onsuccess = function (event) {
            iDB.db = event.target.result;
            var trans = iDB.db.transaction(storeName, 'readwrite').objectStore(storeName);
            trans.clear();
        };
    }
    if (defaults.type === 'new') {
        openDBInsertData(dbName, defaults.storeName, defaults.insertData, defaults.insertKey);
    } else if (defaults.type === 'insert') {
        insertData(dbName, defaults.storeName, defaults.insertData, defaults.insertKey);
    } else if (defaults.type === 'forceInsert') {
        updateData(dbName, defaults.storeName, defaults.insertData, defaults.insertKey);
    } else if (defaults.type === 'remove') {
        removeData(dbName, defaults.storeName, defaults.deleteKey);
        return -1;
    } else if (defaults.type === 'removeAll') {
        clearObjectStore(dbName, defaults.storeName);
        return -1;
    } else if (defaults.type === 'search') {
        search(defaults.type, dbName, defaults.storeName, defaults.searchKey, defaults.searchData);
    } else if (defaults.type === 'searchAll') {
        search(defaults.type, dbName, defaults.storeName);
    } else if (defaults.type === 'edit') {
        search(defaults.type, dbName, defaults.storeName, defaults.searchKey, defaults.searchData, defaults.editData);
    } else if (defaults.type === 'deleteDB') {
        dbObject.deleteDatabase(dbName);
    }
    return this;
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Jun 01 2016 18:44:34 GMT+0900 (KST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
